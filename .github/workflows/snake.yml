name: Generate Daily GitHub Snake

on:
  # Run automatically every day at midnight
  schedule:
    - cron: "0 0 * * *"
  # Allow manual execution
  workflow_dispatch:
  # Run on push to main branch
  push:
    branches:
      - main

jobs:
  generate:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      # 3Ô∏è‚É£ Generate full snake SVGs
      - name: Generate GitHub Contribution Snake
        uses: Platane/snk/svg-only@v3
        with:
          github_user_name: sihabxd
          outputs: |
            dist/full-snake.svg
            dist/full-snake-dark.svg?palette=github-dark

      # 4Ô∏è‚É£ Install dependencies for filtering SVG
      - name: Install dependencies
        run: npm init -y && npm install dayjs fs-extra

      # 5Ô∏è‚É£ Filter SVGs to only today‚Äôs contributions
      - name: Filter SVG to Today Only
        run: |
          node <<'EOF'
          const fs = require('fs-extra');
          const dayjs = require('dayjs');

          const files = ['dist/full-snake.svg', 'dist/full-snake-dark.svg'];
          const today = dayjs().format('YYYY-MM-DD');

          files.forEach(file => {
            if (!fs.existsSync(file)) return;

            let svg = fs.readFileSync(file, 'utf-8');

            // Keep only today‚Äôs contribution
            svg = svg.replace(/<rect x="(\d+)" y="(\d+)" width="\d+" height="\d+" fill="([^"]+)" data-count="\d+" data-date="([^"]+)"[^>]*>/g, (match, x, y, fill, date) => {
              return date === today ? match : '';
            });

            // Save filtered SVG with the exact filenames from your <picture> tag
            const newName = file.includes('dark') ? 'dist/github-contribution-grid-snake-dark.svg' : 'dist/github-contribution-grid-snake.svg';
            fs.writeFileSync(newName, svg, 'utf-8');
          });
          EOF

      # 6Ô∏è‚É£ Push daily-only snake SVGs to output branch
      - name: Push daily snake to output branch
        uses: crazy-max/ghaction-github-pages@v3.1.0
        with:
          build_dir: dist
          target_branch: output
          clean: true
          commit_message: "Update daily GitHub snake üêç"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
